z# Display Listening port and process
# v 1.0
# v 1.1 w/be CIM version but does that work for 5.1 across board?

$ProcColl = @()
$listenPorts = Get-NetTCPConnection | where{$_.OwningProcess -ne 0}| select LocalAddress, LocalPort, RemoteAddress, OwningProcess | Sort-Object OwningProcess -Unique
foreach($1port in $listenPorts)
{
$ProcNm = get-process -id $1port.OwningProcess
$output1 = "" | Select ProcessName, ProcessID, OwningProcess, TcpPort
$output1.ProcessName = $ProcNm.ProcessName
$output1.ProcessID = $ProcNm.ID
$output1.OwningProcess = $1port.OwningProcess
$output1.TcpPort = $1port.LocalPort
$ProcColl += $output1
}

$ProcColl | select TcpPort, OwningProcess, ProcessName | Sort-Object TcpPort

$CimProc = gcim win32_process | where{$_.ProcessId -eq $1port.OwningProcess} # select ParentProcessID, HandleCount, ThreadCount, WorkingSetSize, CommandLine(first 100 chars)
$CimProcOwner = Invoke-cimMethod -inputObject $CimProc -MethodName GetOwner

